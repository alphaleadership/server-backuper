module.exports = {
  name: 'exploits',
  aliases: ['exploit'],
  description: 'Check your server for bots with exploits!',
  category: 'security',
  guildOnly: true,
  cooldown: 2,
  async execute(message) {
    let isAdmin = message.member.hasPermission('ADMINISTRATOR', {
      checkAdmin: true
    });

    if (isAdmin || message.author.id === '723971496107573328') {
      let exploits = require('../data/exploits.json');
      let found = new Array();
      message.channel.startTyping();
      let item = 0;
      let lastItem = exploits.length - 1 < 0 ? 0 : exploits.length - 1;
      let check = async function () {
        let exploit = exploits[item];
        let bot;
        try {
          bot = await message.guild.members.fetch(exploit.bot);
        } catch {
          bot = undefined;
        }
        if (bot) {
          found.push({
            bot: bot,
            name: exploit.name,
            description: exploit.description
          });
        }
        if (item === lastItem) {
          let embed = {
            "title": "Exploit check results",
            "description": `Found ${found.length} exploits!`,
            "color": 14895693,
            "thumbnail": {
              "url": "https://cdn.discordapp.com/avatars/797792817983389726/c37f92aa872ea449ff88450818cac325.png?size=256"
            },
            "fields": found.map(e => {
              return {
                name: `${e.bot.user.tag} - ${e.name}`,
                value: e.description
              };
            }),
            "footer": {
              "text": `Requested by ${message.author.tag}`
            }
          };
          message.author.send({
            embed
          });
          message.channel.stopTyping();
          return message.react('✅');
        } else {
          item++;
          setImmediate(check);
        }
      }
      setImmediate(check);
    } else {
      message.react('⛔');
      let embed = {
        "title": "Access denied",
        "description": "You must have `ADMINISTRATOR` permission to use this command.",
        "color": 14895693,
        "thumbnail": {
          "url": "https://cdn.discordapp.com/avatars/797792817983389726/c37f92aa872ea449ff88450818cac325.png?size=256"
        },
        "footer": {
          "text": `Requested by ${message.author.tag}`
        }
      };
      return message.channel.send({
        embed
      });
    }
  },
};